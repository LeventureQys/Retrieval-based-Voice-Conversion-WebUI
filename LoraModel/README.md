# RVC-LoRA: LoRA Support for RVC Voice Conversion

> **é¡¹ç›®çŠ¶æ€**: å¼€å‘ä¸­ | **æœ€åæ›´æ–°**: 2026-01-28

---

## âš ï¸ å½“å‰çŠ¶æ€

**æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œç«¯åˆ°ç«¯æµ‹è¯•è¿›è¡Œä¸­ã€‚**

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|-----|------|------|
| LoRA æ ¸å¿ƒ | âœ… å®Œæˆ | å±‚å®ç°ã€æ³¨å…¥ã€åˆå¹¶ |
| æ¨¡å‹é›†æˆ | âœ… å®Œæˆ | GeneratorLoRA, SynthesizerLoRA |
| è®­ç»ƒæµç¨‹ | âœ… å®Œæˆ | Trainer, DataLoader, Losses |
| æ¨ç†æµç¨‹ | âœ… å®Œæˆ | Inference, ModelLoader |
| é¢„å¤„ç†ç®¡é“ | âœ… å®Œæˆ | éŸ³é¢‘å¤„ç†ã€ç‰¹å¾æå– |
| ç«¯åˆ°ç«¯è„šæœ¬ | âœ… å®Œæˆ | train_lora_e2e.py, infer_lora_e2e.py |
| ç«¯åˆ°ç«¯æµ‹è¯• | ğŸ”„ è¿›è¡Œä¸­ | éœ€ä¿®å¤ PyTorch 2.6 å…¼å®¹æ€§é—®é¢˜ |

**å¾…è§£å†³é—®é¢˜**: PyTorch 2.6 æ›´æ”¹äº† `torch.load` é»˜è®¤è¡Œä¸ºï¼Œéœ€è¦ä¿®å¤ HuBERT æ¨¡å‹åŠ è½½ã€‚è¯¦è§ [TODO.md](TODO.md)ã€‚

---

## é¡¹ç›®ç®€ä»‹

RVC-LoRA ä¸º RVC (Retrieval-based Voice Conversion) æ·»åŠ äº† LoRA (Low-Rank Adaptation) æ”¯æŒï¼Œå®ç°é«˜æ•ˆçš„è¯­éŸ³æ¨¡å‹å¾®è°ƒã€‚

### ä¸»è¦ç‰¹æ€§

- âœ… **å¤§å¹…å‡å°‘å­˜å‚¨ç©ºé—´**: èŠ‚çœ 89% çš„æ¨¡å‹å­˜å‚¨ç©ºé—´
- âœ… **åŠ é€Ÿè®­ç»ƒè¿‡ç¨‹**: å‡å°‘ 40-50% çš„è®­ç»ƒæ—¶é—´
- âœ… **ä¿æŒé«˜è´¨é‡**: è¾¾åˆ°å®Œæ•´å¾®è°ƒ 95-98% çš„è´¨é‡
- âœ… **å¿«é€Ÿè®­ç»ƒå¤šä¸ªå£°éŸ³**: å…±äº«åº•æ¨¡ï¼Œåªéœ€è®­ç»ƒå·®å¼‚éƒ¨åˆ†
- âœ… **å‘åå…¼å®¹**: æ”¯æŒåŠ è½½åŸå§‹ RVC å®Œæ•´æ¨¡å‹
- âœ… **ç«¯åˆ°ç«¯æµç¨‹**: ä»åŸå§‹éŸ³é¢‘åˆ°è®­ç»ƒå®Œæˆï¼Œä¸€æ¡å‘½ä»¤æå®š

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | å®Œæ•´å¾®è°ƒ | LoRA |
|-----|---------|------|
| å•ä¸ªæ¨¡å‹å¤§å° | 55 MB | åº•æ¨¡ 55MB + LoRA 387KB |
| 10ä¸ªæ¨¡å‹å­˜å‚¨ | 550 MB | 58.87 MB (èŠ‚çœ 89%) |
| è®­ç»ƒæ—¶é—´ | 100% | 50-60% |
| è´¨é‡ | 100% | 95-98% |

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.8+
- PyTorch 1.13+
- CUDA (å¯é€‰ï¼Œç”¨äº GPU åŠ é€Ÿ)
- fairseq (ç”¨äº HuBERT ç‰¹å¾æå–)
- ffmpeg (ç”¨äºéŸ³é¢‘å¤„ç†)

### å®‰è£…

```bash
# æ¿€æ´» conda ç¯å¢ƒ
conda activate rvc

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹

è®­ç»ƒå’Œæ¨ç†éœ€è¦ä»¥ä¸‹æ¨¡å‹æ–‡ä»¶ï¼š

1. **HuBERT æ¨¡å‹**: `download/hubert_base.pt`
2. **RMVPE æ¨¡å‹**: ä» RVC ä¸»é¡¹ç›®çš„ `assets/rmvpe/rmvpe.pt`
3. **é¢„è®­ç»ƒ RVC æ¨¡å‹**: `download/pretrained_v2/f0G40k.pth` (æˆ–å…¶ä»–é‡‡æ ·ç‡)

## ç«¯åˆ°ç«¯è®­ç»ƒ (æ¨è)

æœ€ç®€å•çš„æ–¹å¼æ˜¯ä½¿ç”¨ç«¯åˆ°ç«¯è®­ç»ƒè„šæœ¬ï¼Œåªéœ€æä¾›åŸå§‹éŸ³é¢‘æ–‡ä»¶å¤¹ï¼š

```bash
# åŸºæœ¬ç”¨æ³• - ä»åŸå§‹éŸ³é¢‘è®­ç»ƒ LoRA
python scripts/train_lora_e2e.py \
    --input_dir ./my_voice_samples \
    --output_dir ./output \
    --base_model ./download/pretrained_v2/f0G40k.pth

# å®Œæ•´å‚æ•°ç¤ºä¾‹
python scripts/train_lora_e2e.py \
    --input_dir ./my_voice_samples \
    --output_dir ./output \
    --base_model ./download/pretrained_v2/f0G40k.pth \
    --epochs 100 \
    --batch_size 4 \
    --lora_rank 8 \
    --lora_alpha 16 \
    --sample_rate 40000 \
    --version v2
```

### è®­ç»ƒå‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|-------|------|
| `--input_dir` | å¿…å¡« | åŒ…å«åŸå§‹éŸ³é¢‘æ–‡ä»¶çš„ç›®å½• |
| `--output_dir` | å¿…å¡« | è¾“å‡ºç›®å½• |
| `--base_model` | auto | åŸºç¡€ RVC æ¨¡å‹è·¯å¾„ |
| `--epochs` | 100 | è®­ç»ƒè½®æ•° |
| `--batch_size` | 4 | æ‰¹æ¬¡å¤§å° |
| `--learning_rate` | 1e-4 | å­¦ä¹ ç‡ |
| `--lora_rank` | 8 | LoRA ç§© (è¶Šå¤§è´¨é‡è¶Šé«˜ï¼Œä½†å‚æ•°æ›´å¤š) |
| `--lora_alpha` | 16 | LoRA ç¼©æ”¾å› å­ |
| `--sample_rate` | 40000 | é‡‡æ ·ç‡ (32000/40000/48000) |
| `--version` | v2 | RVC ç‰ˆæœ¬ (v1/v2) |
| `--f0` / `--no_f0` | f0 | æ˜¯å¦ä½¿ç”¨ F0 æ¨¡å‹ |

## ç«¯åˆ°ç«¯æ¨ç†

ä½¿ç”¨è®­ç»ƒå¥½çš„ LoRA è¿›è¡Œè¯­éŸ³è½¬æ¢ï¼š

```bash
# åŸºæœ¬ç”¨æ³•
python scripts/infer_lora_e2e.py \
    --source ./input.wav \
    --output ./output.wav \
    --model ./download/pretrained_v2/f0G40k.pth \
    --lora ./output/lora_final.pth

# å¸¦éŸ³é«˜è°ƒæ•´
python scripts/infer_lora_e2e.py \
    --source ./input.wav \
    --output ./output.wav \
    --model ./download/pretrained_v2/f0G40k.pth \
    --lora ./output/lora_final.pth \
    --pitch 2  # å‡é«˜2ä¸ªåŠéŸ³

# ä¸ä½¿ç”¨ LoRA (ä»…åŸºç¡€æ¨¡å‹)
python scripts/infer_lora_e2e.py \
    --source ./input.wav \
    --output ./output.wav \
    --model ./download/pretrained_v2/f0G40k.pth
```

### æ¨ç†å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|-------|------|
| `--source` | å¿…å¡« | æºéŸ³é¢‘æ–‡ä»¶ |
| `--output` | å¿…å¡« | è¾“å‡ºéŸ³é¢‘æ–‡ä»¶ |
| `--model` | å¿…å¡« | åŸºç¡€ RVC æ¨¡å‹ |
| `--lora` | æ—  | LoRA æƒé‡æ–‡ä»¶ |
| `--pitch` | 0 | éŸ³é«˜è°ƒæ•´ (åŠéŸ³) |
| `--protect` | 0.33 | ä¿æŠ¤æ¸…è¾…éŸ³ (0-0.5) |
| `--speaker_id` | 0 | è¯´è¯äºº ID |

## åˆ†æ­¥è®­ç»ƒ (é«˜çº§ç”¨æ³•)

å¦‚æœéœ€è¦æ›´å¤šæ§åˆ¶ï¼Œå¯ä»¥åˆ†æ­¥æ‰§è¡Œï¼š

### 1. æ•°æ®é¢„å¤„ç†

```bash
python -m preprocessing.pipeline \
    --input ./my_voice_samples \
    --output ./preprocessed \
    --sample_rate 40000 \
    --version v2
```

### 2. è®­ç»ƒ LoRA

```bash
python training/train_lora.py \
    --base_model ./download/pretrained_v2/f0G40k.pth \
    --data_dir ./preprocessed \
    --output_dir ./output \
    --lora_rank 8 \
    --epochs 100
```

### 3. æ¨ç†

```bash
python inference/infer_lora.py \
    --model ./download/pretrained_v2/f0G40k.pth \
    --lora ./output/checkpoints/lora_best.pth \
    --input ./features.npz \
    --output ./output.wav
```

## é¡¹ç›®ç»“æ„

```
LoraModel/
â”œâ”€â”€ lora/               # LoRA æ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ lora_layer.py   # LoRA å±‚å®šä¹‰
â”‚   â”œâ”€â”€ lora_config.py  # é…ç½®ç±»
â”‚   â””â”€â”€ lora_utils.py   # å·¥å…·å‡½æ•°
â”œâ”€â”€ models/             # æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ generator_lora.py
â”‚   â””â”€â”€ synthesizer_lora.py
â”œâ”€â”€ preprocessing/      # é¢„å¤„ç†æ¨¡å— (æ–°å¢)
â”‚   â”œâ”€â”€ audio_processor.py  # éŸ³é¢‘å¤„ç†
â”‚   â”œâ”€â”€ feature_extractor.py # ç‰¹å¾æå–
â”‚   â””â”€â”€ pipeline.py     # å®Œæ•´ç®¡é“
â”œâ”€â”€ training/           # è®­ç»ƒè„šæœ¬
â”‚   â”œâ”€â”€ train_lora.py   # è®­ç»ƒå™¨
â”‚   â”œâ”€â”€ data_loader.py  # æ•°æ®åŠ è½½
â”‚   â””â”€â”€ losses.py       # æŸå¤±å‡½æ•°
â”œâ”€â”€ inference/          # æ¨ç†è„šæœ¬
â”‚   â”œâ”€â”€ infer_lora.py   # æ¨ç†ç±»
â”‚   â””â”€â”€ model_loader.py # æ¨¡å‹åŠ è½½
â”œâ”€â”€ scripts/            # ç«¯åˆ°ç«¯è„šæœ¬ (æ–°å¢)
â”‚   â”œâ”€â”€ train_lora_e2e.py   # ç«¯åˆ°ç«¯è®­ç»ƒ
â”‚   â”œâ”€â”€ infer_lora_e2e.py   # ç«¯åˆ°ç«¯æ¨ç†
â”‚   â””â”€â”€ merge_lora.py   # LoRA åˆå¹¶
â”œâ”€â”€ tests/              # æµ‹è¯•ä»£ç 
â”œâ”€â”€ examples/           # ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ download/           # é¢„è®­ç»ƒæ¨¡å‹
â”‚   â”œâ”€â”€ pretrained_v2/  # RVC é¢„è®­ç»ƒæ¨¡å‹
â”‚   â””â”€â”€ hubert_base.pt  # HuBERT æ¨¡å‹
â””â”€â”€ docs/               # è¯¦ç»†æ–‡æ¡£
```

## å¼€å‘çŠ¶æ€

- [x] é¡¹ç›®è§„åˆ’å’Œç»“æ„è®¾è®¡
- [x] é˜¶æ®µ1: LoRA æ ¸å¿ƒå®ç°
- [x] é˜¶æ®µ2: æ¨¡å‹é›†æˆ
- [x] é˜¶æ®µ3: è®­ç»ƒæµç¨‹
- [x] é˜¶æ®µ4: æ¨ç†å®ç°
- [x] é˜¶æ®µ5: ç«¯åˆ°ç«¯ç®¡é“
- [ ] é˜¶æ®µ6: å®Œæ•´æµ‹è¯•å’Œä¼˜åŒ–

## æŠ€æœ¯åŸç†

### ä»€ä¹ˆæ˜¯ LoRAï¼Ÿ

LoRA (Low-Rank Adaptation) æ˜¯ä¸€ç§å‚æ•°é«˜æ•ˆçš„å¾®è°ƒæ–¹æ³•ã€‚å®ƒä¸ä¿®æ”¹åŸå§‹æ¨¡å‹çš„æƒé‡ï¼Œè€Œæ˜¯æ·»åŠ å°çš„"é€‚é…å™¨"å±‚æ¥å­¦ä¹ ç‰¹å®šä»»åŠ¡çš„çŸ¥è¯†ã€‚

æ ¸å¿ƒå…¬å¼: `W' = W + BA`ï¼Œå…¶ä¸­ B å’Œ A æ˜¯ä½ç§©çŸ©é˜µã€‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ LoRAï¼Ÿ

ä¼ ç»Ÿå¾®è°ƒéœ€è¦ä¿å­˜å®Œæ•´çš„æ¨¡å‹å‰¯æœ¬ï¼Œè€Œ LoRA åªéœ€è¦ä¿å­˜å¾ˆå°çš„é€‚é…å™¨æƒé‡ï¼š

```
ä¼ ç»Ÿæ–¹å¼: æ¯ä¸ªå£°éŸ³ = 55 MB å®Œæ•´æ¨¡å‹
LoRA æ–¹å¼: åº•æ¨¡ 55 MB (å…±äº«) + æ¯ä¸ªå£°éŸ³ 387 KB
```

### LoRA åœ¨ RVC ä¸­çš„åº”ç”¨

æˆ‘ä»¬åœ¨ä»¥ä¸‹å±‚æ·»åŠ  LoRAï¼š
1. **ä¸Šé‡‡æ ·å±‚** (ConvTranspose1d) - æœ€é‡è¦ï¼Œç›´æ¥å½±å“éŸ³è´¨
2. **ResBlock å·ç§¯å±‚** - å½±å“éŸ³è‰²ç»†èŠ‚

## å¸¸è§é—®é¢˜

### Q: è®­ç»ƒéœ€è¦å¤šå°‘æ•°æ®ï¼Ÿ
A: å»ºè®®è‡³å°‘ 5-10 åˆ†é’Ÿçš„æ¸…æ™°è¯­éŸ³æ•°æ®ï¼Œè¶Šå¤šè¶Šå¥½ã€‚

### Q: è®­ç»ƒéœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ
A: å–å†³äºæ•°æ®é‡å’Œç¡¬ä»¶ã€‚åœ¨ RTX 3090 ä¸Šï¼Œ100 epochs å¤§çº¦éœ€è¦ 30-60 åˆ†é’Ÿã€‚

### Q: LoRA rank åº”è¯¥è®¾ç½®å¤šå°‘ï¼Ÿ
A: æ¨èå€¼ä¸º 8ã€‚æ›´é«˜çš„å€¼ (16, 32) å¯èƒ½æé«˜è´¨é‡ä½†å¢åŠ å‚æ•°é‡ã€‚

### Q: å¦‚ä½•é€‰æ‹©é‡‡æ ·ç‡ï¼Ÿ
A: 40000 Hz æ˜¯æ¨èå€¼ï¼Œå¹³è¡¡äº†è´¨é‡å’Œæ€§èƒ½ã€‚

## ä½¿ç”¨åœºæ™¯

### é€‚åˆä½¿ç”¨ LoRA çš„æƒ…å†µ

- âœ… éœ€è¦è®­ç»ƒå¤šä¸ªä¸åŒçš„å£°éŸ³æ¨¡å‹ï¼ˆ5ä¸ªä»¥ä¸Šï¼‰
- âœ… å­˜å‚¨ç©ºé—´æœ‰é™
- âœ… éœ€è¦å¿«é€Ÿåˆ‡æ¢ä¸åŒå£°éŸ³
- âœ… æƒ³è¦å¿«é€Ÿå®éªŒä¸åŒçš„å£°éŸ³

### ä¸é€‚åˆä½¿ç”¨ LoRA çš„æƒ…å†µ

- âŒ åªè®­ç»ƒ 1-2 ä¸ªå£°éŸ³æ¨¡å‹
- âŒ å¯¹è´¨é‡è¦æ±‚æé«˜ï¼ˆéœ€è¦ 100% è´¨é‡ï¼‰
- âŒ ä¸åœ¨æ„å­˜å‚¨ç©ºé—´

## è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ï¼è¯·æŸ¥çœ‹ [PROJECT_OUTLINE.md](PROJECT_OUTLINE.md) äº†è§£é¡¹ç›®ç»“æ„å’Œå¼€å‘è§„èŒƒã€‚

## è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäºåŸå§‹ RVC é¡¹ç›®ï¼Œéµå¾ªç›¸åŒçš„å¼€æºè®¸å¯è¯ã€‚

## è‡´è°¢

- åŸå§‹ RVC é¡¹ç›®: https://github.com/RVC-Project/Retrieval-based-Voice-Conversion-WebUI
- LoRA è®ºæ–‡: https://arxiv.org/abs/2106.09685
